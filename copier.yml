_min_copier_version: "9.0.0"
_tasks:
  - mv specs/graph-sync/AGENTS.md AGENTS.md
  - |
      python - <<'PY'
      from pathlib import Path
      import shutil

      profiles = {{ profiles | tojson }}
      default_profile_dir = Path("profiles/default")
      seed_files = (
          "exports.toml.j2",
          "mappings/default.yarrrml.j2",
          "templates/1_organization.ttl.j2",
          "templates/2_website.ttl.j2",
      )

      for profile in profiles:
          profile_dir = Path("profiles") / profile
          (profile_dir / "mappings").mkdir(parents=True, exist_ok=True)
          (profile_dir / "templates").mkdir(parents=True, exist_ok=True)
          (profile_dir / "postprocessors").mkdir(parents=True, exist_ok=True)

          if profile == "default":
              continue

          for rel_path in seed_files:
              src = default_profile_dir / rel_path
              dst = profile_dir / rel_path
              if dst.exists():
                  continue
              dst.parent.mkdir(parents=True, exist_ok=True)
              shutil.copy2(src, dst)
      PY
  - |
      python - <<'PY'
      from pathlib import Path

      api_key = {{ api_key | tojson }}
      sheets_service_account = {{ (sheets_service_account if source_type == "google_sheets" else "") | tojson }}

      # Keep secrets out of tracked config by writing them into local .env.
      escaped_service_account = sheets_service_account.replace("\n", "\\n")
      
      content = [
          f"WORDLIFT_API_KEY={api_key}",
          f"SHEETS_SERVICE_ACCOUNT={escaped_service_account}",
          "YOUTUBE_API_KEY=",
          "",
      ]
      Path(".env").write_text("\\n".join(content), encoding="utf-8")
      PY

project_slug:
  type: str
  help: Project slug (repo/folder name)

customer_name:
  type: str
  help: Customer display name

api_key:
  type: str
  secret: true
  default: ""
  help: WordLift API key used by generated profiles
  validator: "{% if not api_key or not api_key|trim %}api_key is required{% endif %}"

source_type:
  type: str
  help: Source import type
  choices:
    - urls
    - sitemap
    - google_sheets

urls:
  type: yaml
  help: List of URLs to import
  when: "{{ source_type == 'urls' }}"

sitemap_url:
  type: str
  help: Source sitemap URL
  when: "{{ source_type == 'sitemap' }}"

sitemap_url_pattern:
  type: str
  default: ""
  help: Optional regex/pattern to filter sitemap URLs
  when: "{{ source_type == 'sitemap' }}"

sheets_url:
  type: str
  help: Google Sheets URL
  when: "{{ source_type == 'google_sheets' }}"

sheets_name:
  type: str
  help: Google Sheets tab name
  when: "{{ source_type == 'google_sheets' }}"

sheets_service_account:
  type: str
  secret: true
  default: ""
  help: Service account JSON or path
  when: "{{ source_type == 'google_sheets' }}"
  validator: "{% if source_type == 'google_sheets' and not sheets_service_account %}sheets_service_account is required when source_type=google_sheets{% endif %}"

overwrite:
  type: bool
  default: true
  help: Overwrite existing entities during import

concurrency:
  type: int
  default: 8
  help: Import concurrency

web_page_import_mode:
  type: str
  default: ""
  help: Optional worai import mode

web_page_import_timeout:
  type: int
  default: 30
  help: Optional import timeout in seconds

google_search_console:
  type: bool
  default: false
  help: Enable Google Search Console integration

profiles:
  type: yaml
  default:
    - default
  help: List of profile names to generate and sync
  validator: "{% if not profiles or profiles|length == 0 %}profiles must include at least one profile{% endif %}"

default_profile:
  type: str
  default: default
  help: Default profile for local run/docs/workflow dispatch
  validator: "{% if default_profile not in profiles %}default_profile must be one of the selected profiles{% endif %}"
