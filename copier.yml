_min_copier_version: "9.0.0"
_exclude:
  - ".git"
  - ".git/**"
  - ".github/workflows/template-smoke.yml"
_tasks:
  - mv specs/graph-sync/AGENTS.md AGENTS.md
  - |
      python - <<'PY'
      from pathlib import Path
      import shutil

      profiles = {{ profiles | tojson }}
      default_profile_dir = Path("profiles/default")
      seed_files = (
          "exports.toml.j2",
          "mappings/default.yarrrml.j2",
          "templates/1_organization.ttl.j2",
          "templates/2_website.ttl.j2",
      )

      for profile in profiles:
          profile_dir = Path("profiles") / profile
          (profile_dir / "mappings").mkdir(parents=True, exist_ok=True)
          (profile_dir / "templates").mkdir(parents=True, exist_ok=True)
          (profile_dir / "postprocessors").mkdir(parents=True, exist_ok=True)

          if profile == "default":
              continue

          for rel_path in seed_files:
              src = default_profile_dir / rel_path
              dst = profile_dir / rel_path
              if dst.exists():
                  continue
              dst.parent.mkdir(parents=True, exist_ok=True)
              shutil.copy2(src, dst)
      PY
  - |
      python - <<'PY'
      from pathlib import Path

      api_key = {{ api_key | tojson }}
      sheets_service_account = {{ (sheets_service_account if source_type == "google_sheets" else "") | tojson }}

      # Keep secrets out of tracked config by writing them into local .env.
      escaped_service_account = sheets_service_account.replace("\n", "\\n")
      
      content = [
          f"WORDLIFT_API_KEY={api_key}",
          f"SHEETS_SERVICE_ACCOUNT={escaped_service_account}",
          "YOUTUBE_API_KEY=",
          "",
      ]
      Path(".env").write_text(chr(10).join(content), encoding="utf-8")
      PY

api_key:
  type: str
  secret: true
  default: ""
  help: WordLift API key (required)
  validator: "{% if not api_key or not api_key|trim %}api_key is required{% endif %}"

source_type:
  type: str
  help: Source of your page list
  choices:
    "Manual URL list": urls
    "Sitemap XML": sitemap
    "Google Sheets": google_sheets

urls:
  type: yaml
  help: Page URLs (YAML list)
  when: "{{ source_type == 'urls' }}"
  validator: "{% if source_type == 'urls' and (not urls or urls|length == 0) %}urls is required when source_type=urls{% endif %}"

sitemap_url:
  type: str
  help: Sitemap URL
  when: "{{ source_type == 'sitemap' }}"
  validator: "{% if source_type == 'sitemap' and (not sitemap_url or not sitemap_url|trim) %}sitemap_url is required when source_type=sitemap{% endif %}"

sitemap_url_pattern:
  type: str
  default: ""
  help: Sitemap URL filter pattern (optional regex)
  when: "{{ source_type == 'sitemap' }}"

sheets_url:
  type: str
  help: Google Sheets document URL
  when: "{{ source_type == 'google_sheets' }}"
  validator: "{% if source_type == 'google_sheets' and (not sheets_url or not sheets_url|trim) %}sheets_url is required when source_type=google_sheets{% endif %}"

sheets_name:
  type: str
  help: Google Sheets tab name
  when: "{{ source_type == 'google_sheets' }}"
  validator: "{% if source_type == 'google_sheets' and (not sheets_name or not sheets_name|trim) %}sheets_name is required when source_type=google_sheets{% endif %}"

sheets_service_account:
  type: str
  secret: true
  default: ""
  help: Google service account (JSON or path)
  when: "{{ source_type == 'google_sheets' }}"
  validator: "{% if source_type == 'google_sheets' and not sheets_service_account %}sheets_service_account is required when source_type=google_sheets{% endif %}"

overwrite:
  type: bool
  default: true
  help: Overwrite existing entities

concurrency:
  type: int
  default: 4
  help: Parallel import workers
  when: "{{ false }}"

web_page_import_mode:
  type: str
  default: ""
  help: Import mode override (optional)
  when: "{{ false }}"

web_page_import_timeout:
  type: int
  default: 120
  help: Per-page timeout (seconds)
  when: "{{ false }}"

google_search_console:
  type: bool
  default: false
  help: Enable Google Search Console enrichment
  when: "{{ false }}"

profiles:
  type: yaml
  default:
    - default
  help: Profiles to generate (YAML list)
  validator: "{% if not profiles or profiles|length == 0 %}profiles must include at least one profile{% endif %}"
  when: "{{ false }}"

default_profile:
  type: str
  default: default
  help: Default profile
  validator: "{% if default_profile not in profiles %}default_profile must be one of the selected profiles{% endif %}"
  when: "{{ false }}"
