name: Graph Sync

on:
  workflow_dispatch:
    inputs:
      profile:
        description: Profile to sync
        required: true
        type: choice
        options:
          - default
          - all
      debug:
        description: Enable debug mode
        required: false
        default: false
        type: boolean

  workflow_call:
    inputs:
      profile:
        required: true
        type: string
      debug:
        required: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: graph-sync
  cancel-in-progress: false

jobs:
  graph-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    strategy:
      matrix:
        profile: ${{ inputs.profile == 'all'
          && fromJson('["default"]')
          || fromJson(format('["{0}"]', inputs.profile)) }}

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6
        with:
          python-version: '3.13'
          enable-cache: true
          cache-python: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - run: uv sync --locked --no-dev

      - uses: wordlift/graph-sync@v1
        with:
          profile: ${{ matrix.profile }}
          debug: ${{ inputs.debug }}
        env:
          WORDLIFT_API_KEY: ${{ secrets.WORDLIFT_API_KEY }}
          SHEETS_SERVICE_ACCOUNT: ${{ secrets.SHEETS_SERVICE_ACCOUNT }}
